<!doctype html> 
<html lang="en"> 
<head> 
    <meta charset="UTF-8" />
    <title>Phaser - Making your first game, part 1</title>
    <!-- <script src="phaser.min.js"></script> -->
    <script src="phaser-ce-2.10.0/build/phaser.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script type="text/javascript">

var game = new Phaser.Game(800, 600, Phaser.AUTO, '', { preload: preload, create: create, update: update });

var platforms;

function preload() {
    game.load.image("star", "assets/star.png");
    game.load.image("pizza", "assets/pizza.png")
}

var qKey;
var players = [];
function create() {
    game.physics.startSystem(Phaser.Physics.P2JS);
    players.push(new Player('A', 'pizza', game, 50, 50));
    players.push(new Player('B', 'star', game, 100, 100));
    game.add.sprite(0, 0, "star");
}

function update() {
    // Check player input
    players.forEach((player) => {
        player.processInput();
    });
}

const PLAYER_STATES = Object.freeze({
    default: 0,
    spinning: 1,
    firing: 2,
    moving: 3
});

const ANGULAR_ACCELERATION = 1;
const MAX_ANGULAR_VELOCITY = 100;

class Player {
    /**
     * key is control assigned to this player
     * optional: x, y coords
    **/
    constructor (cKey, sImageName, oGame, x, y) {
        this._sprite = game.add.sprite(x, y, sImageName);
        game.physics.p2.enable(this._sprite);

        this._keyName = cKey;
        this._key = game.input.keyboard.addKey(Phaser.Keyboard[cKey.toUpperCase()]);

        this._state = PLAYER_STATES.default;
        this._power = 0;
        this._angularVelocity = 0;
    }

    processInput () {
        if (this._key.justDown) {
            this._onDown();
        } else if (this._key.justUp) {
            this._onUp();
        }
        // console.log(`${this._keyName} is processing.`);
    }

    _onDown () {
        this._power++;
        this._angularVelocity++
        console.log(`${this._keyName} is charging!`)
    }

    _onUp () {
        this.fireBeam(this._angularVelocity, this._power);
        this._power = 0;
        this._angularVelocity = 0;
        this._state = 2;
    }

    fireBeam () {
        // TODO: implement
        console.log(`${this._keyName} is firing!`);
    }

    charge() {
        // As long as our key is down:
        // - increment power over time
        // - increase spin rate over time

    }

    move(angle, power) {
        //TODO: implement movement
    }
}

</script>

</body>
</html>