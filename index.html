<!doctype html> 
<html lang="en"> 
<head> 
    <meta charset="UTF-8" />
    <title>Phaser - Making your first game, part 1</title>
    <!-- <script src="phaser.min.js"></script> -->
    <script src="phaser-ce-2.10.0/build/phaser.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script type="text/javascript">

var game = new Phaser.Game(800, 600, Phaser.AUTO, '', { preload: preload, create: create, update: update });

var platforms;

var qKey;
var players = [];
var gameTime = 0;

function preload() {
    game.load.image("star", "assets/star.png");
    game.load.image("pizza", "assets/pizza.png")
}

function create() {
    game.physics.startSystem(Phaser.Physics.P2JS);
    players.push(new Player('A', 'pizza', game, 500, 500));
    players.push(new Player('B', 'star', game, 100, 100));
    game.add.sprite(0, 0, "star");
}

function update() {
    gameTime = game.time.elapsed;
    // Check player input
    players.forEach((player) => {
        player.processInput();
    });
    game.debug.text(players[0].getDebugInfo(), 10, 100);
    game.debug.spriteInfo(players[0]._sprite);
}

const PLAYER_STATES = Object.freeze({
    default: 0,
    spinning: 1,
    firing: 2,
    moving: 3
});

const DEFAULT_ANGULAR_VELOCITY = 1;
const ANGULAR_CHARGE_RATE = .5;
const MAX_ANGULAR_VELOCITY = 100;

const POWER_CHARGE_RATE = .1;

class Player {
    /**
     * key is control assigned to this player
     * optional: x, y coords
    **/
    constructor (cKey, sImageName, oGame, x, y) {
        this._sprite = game.add.sprite(x, y, sImageName);
        game.physics.p2.enable(this._sprite);

        this._keyName = cKey;
        this._key = game.input.keyboard.addKey(Phaser.Keyboard[cKey.toUpperCase()]);

        this._state = PLAYER_STATES.default;
        this._power = 0;
        this._angularVelocity = DEFAULT_ANGULAR_VELOCITY;
    }

    processInput () {
        if (this._key.justDown) {
            this._onDown();
        } else if (this._key.justUp) {
            this._onUp();
        } else if (this._key.isDown) {
            this._isDown();
        } else {
            this._idle();
        }
        // console.log(`${this._keyName} is processing.`);
    }

    _idle() {
        this._sprite.body.rotation += this._angularVelocity / gameTime;
    }

    _onDown () {
        this._state = PLAYER_STATES.spinning;
        console.log(`${this._keyName} is charging!`)
    }

    _isDown() {
        this._power += POWER_CHARGE_RATE;
        this._angularVelocity += ANGULAR_CHARGE_RATE / gameTime;
        this._sprite.body.rotation += this._angularVelocity / gameTime;
    }

    _onUp () {
        this._state = PLAYER_STATES.firing;
        this._angularVelocity = DEFAULT_ANGULAR_VELOCITY;
        this.fireBeam();
        this._power = 0;
        this._state = 2;
    }

    fireBeam () {
        // TODO: implement
        let fireAngle = this._sprite.body.angle;
        console.log(`${this._keyName} is firing at ${fireAngle} degrees for ${this._power} distance!`);
    }

    charge() {
        // As long as our key is down:
        // - increment power over time
        // - increase spin rate over time

    }

    move(angle, power) {
        //TODO: implement movement
    }

    getDebugInfo() {
        return `Player ${this._keyName}:: Angular Velocity: ${this._angularVelocity} Power: ${this._power} State: ${this._state}`;
    }
}

</script>

</body>
</html>