<!doctype html> 
<html lang="en"> 
<head> 
    <meta charset="UTF-8" />
    <title>Space Golf</title>
    <script src="phaser.min.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script type="text/javascript">

var game = new Phaser.Game(1280, 720, Phaser.AUTO, '', { preload: preload, create: create, update: update, render: render });

var playerShoot;
var spark;

var speed = 600;
var maxCharge = 300;
var charge = maxCharge;

var bounds;
var beams;
var beamSprites;
var lastIntersection;

function preload() {

    game.load.image("star", "assets/pizza.png");
    game.load.image("spark", "assets/spark.png");
}

function create() {

    game.physics.startSystem(Phaser.Physics.P2JS);

    playerShoot = game.add.sprite(game.world.width/2, game.world.height-100, "star");
    playerShoot.anchor.set(0.5);
    spark = game.add.sprite(game.world.width/2, game.world.height-100, "spark").alignTo(playerShoot, Phaser.TOP_CENTER);
    spark.anchor.set(0.5);
    

    game.physics.p2.enable(spark);
    spark.fixedRotation = true;
    spark.body.fixedRotation = true;
    playerShoot.scale.x = 2;
    playerShoot.scale.y = 2;

    spark.body.angle = 45;

    bounds =[
        new Phaser.Line(10, 10, game.world.width-10, 40),
        new Phaser.Line(10, game.world.height-10, game.world.width, game.world.height-10),
        new Phaser.Line(40, 10, 10, game.world.height-10),
        new Phaser.Line(game.world.width-10, 40, game.world.width-10, game.world.height-10)
    ];

    beams = [new Phaser.Line(playerShoot.x, playerShoot.y, spark.x, spark.y)];
    beamSprites = [];

    lastIntersection = -1;
    
}

function update() {
    laserUpdate();
}

function lastBeam() {
    return beams[beams.length-1];
}

function lastBeamSprite() {
    return beamSprites[beamSprites.length - 1];
}

function laserUpdate() {
    if (charge > 0) {
        spark.body.moveForward(speed);
        if (beamSprites.length > 0) {
            lastBeam().fromSprite(lastBeamSprite(), spark, true);
        } else {
            lastBeam().fromSprite(playerShoot, spark, true);  
        }       
        // charge--;

    } else {
        spark.body.setZeroVelocity();
    }

    bounds.forEach(function(item, index, array) {
        bouncePoint = lastBeam().intersects(item);
        if (bouncePoint && lastIntersection != index) {
            onIntersect(lastBeam(), item);
            lastIntersection = index;
        }
        
    });
    bouncePoint = null;
}

function onIntersect(beam, bound) {
        
        var bounceSpark = game.add.sprite(bouncePoint.x, bouncePoint.y, "spark");  
        bounceSpark.anchor.set(.5);  
        beamSprites.push(bounceSpark);
        
        var angleOfReflection = beam.reflect(bound);

        var outBeam = new Phaser.Line().fromAngle(bouncePoint.x, bouncePoint.y, angleOfReflection, 20);

        spark.body.x = outBeam.end.x;
        spark.body.y = outBeam.end.y;
        spark.body.rotation = angleOfReflection+Math.PI/2;

        beams.push(outBeam);
}

function render() {

    beams.forEach(function(item, index, array) {
        game.debug.geom(item, '#ff0000');
    });
    bounds.forEach(function(item, index, array) {
        game.debug.geom(item, '#00ff00');
    });

    // game.debug.spriteInfo(spark, 32, 170);  
}

</script>

</body>
</html>